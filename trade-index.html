<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Web Application (Defaults at Top)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:1000px;margin:auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px}
    .header{text-align:center;margin-bottom:16px}
    .header h1{margin:0 0 6px 0;font-size:22px}
    .controls{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-end;margin-bottom:12px}
    .controls label{display:flex;flex-direction:column;font-weight:600;font-size:.92rem}
    .controls input{padding:8px 10px;border:1px solid #cbd5e1;border-radius:6px;font-size:.92rem}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{padding:8px 16px;border:none;border-radius:6px;background:#667eea;color:#fff;font-weight:600;cursor:pointer}
    button:hover{background:#5567c9}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;border:1px solid #e5e7eb;text-align:left;font-size:.92rem}
    th{background:#667eea;color:#fff}
    tr:nth-child(even){background:#f9fafb}
    .status{margin-top:12px;padding:10px;border-radius:6px;display:none}
    .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .loading{display:none;text-align:center;margin:12px 0;color:#667eea;font-weight:600}

    /* Toggle switch */
    .toggle-container{display:flex;align-items:center;gap:8px;margin-left:4px}
    .toggle-switch{position:relative;display:inline-block;width:52px;height:28px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:#cbd5e1;transition:.3s;border-radius:28px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;background:#fff;transition:.3s;border-radius:50%}
    .toggle-switch input:checked + .slider{background:#667eea}
    .toggle-switch input:checked + .slider:before{transform:translateX(24px)}
  </style>
</head>
<body>
  <script>
    // All default values in one place
    const DEFAULTS = {
      spread: 0.01,
      rateKA: 17.7055,
      ratePN: 1,
      basedOnExecution: true,
      table: {
        tradeprofit: 1,
        profitfactor: 1 ,
        returnmin: 2,
        returnmax: 2,
        factormin: 3,
        factormax: 3
      }
    };
  </script>

  <div class="container">
    <div class="header">
      <h1>Trade Web Application</h1>
      <p>Simple Trading Calculations with Real-time Updates</p>
    </div>

    <!-- Top row: inputs -->
    <div class="controls">
      <label>
        Spread
        <input type="number" id="spread" step="0.01"/>
      </label>
      <label>
        Rate KA
        <input type="number" id="rateKA" step="0.01"/>
      </label>
      <label>
        Rate PN
        <input type="number" id="ratePN" step="0.01"/>
      </label>
    </div>

    <!-- Actions row: buttons + toggle -->
    <div class="actions">
      <button onclick="runQuery()">Run Calculations</button>
      <button onclick="loadData()">Refresh Data</button>

      <div class="toggle-container" title="Toggle calculation mode">
        <span style="font-weight:600;color:#334155">Based on Execution</span>
        <label class="toggle-switch">
          <input type="checkbox" id="basedOnExecution"/>
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="loading" id="loading">Processing calculations...</div>

    <table>
      <thead>
        <tr>
          <th>Variable</th>
          <th>Minimum</th>
          <th>Maximum</th>
          <th>Factor Min</th>
          <th>Factor Max</th>
          <th>Return Min</th>
          <th>Return Max</th>
        </tr>
      </thead>
      <tbody id="dataTable"></tbody>
    </table>

    <div id="status" class="status"></div>
  </div>

  <script>
    // Set input and toggle defaults from DEFAULTS
    document.getElementById('spread').value = DEFAULTS.spread;
    document.getElementById('rateKA').value = DEFAULTS.rateKA;
    document.getElementById('ratePN').value = DEFAULTS.ratePN;
    document.getElementById('basedOnExecution').checked = DEFAULTS.basedOnExecution;

    let currentData = [];

    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
      showLoading(true);
      try {
        const response = await fetch('/api/data');
        const result = await response.json();
        if (result.data) {
          currentData = result.data;
          populateTable(result.data);
          showStatus('Data loaded successfully', 'success');
        } else {
          // Use table defaults if no data
          populateTable([{
            variable: 'tradeprofit',
            minimum: DEFAULTS.table.tradeprofit,
            maximum: DEFAULTS.table.tradeprofit,
            factormin: DEFAULTS.table.factormin,
            factormax: DEFAULTS.table.factormax,
            returnmin: DEFAULTS.table.returnmin,
            returnmax: DEFAULTS.table.returnmax
          }]);
          showStatus('No data received, using defaults', 'error');
        }
      } catch (error) {
        showStatus('Error loading data: ' + error.message, 'error');
      }
      showLoading(false);
    }

    function populateTable(data) {
      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.variable}</td>
          <td><input type="number" step="0.000001" value="${item.minimum}"
              onchange="updateValue('${item.variable}', 'minimum', this.value)"></td>
          <td><input type="number" step="0.000001" value="${item.maximum}"
              onchange="updateValue('${item.variable}', 'maximum', this.value)"></td>
          <td>${parseFloat(item.factormin).toFixed(6)}</td>
          <td>${parseFloat(item.factormax).toFixed(6)}</td>
          <td>${parseFloat(item.returnmin).toFixed(6)}</td>
          <td>${parseFloat(item.returnmax).toFixed(6)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function updateValue(variable, column, value) {
      try {
        const response = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ variable, column, value })
        });
        const result = await response.json();
        if (result.success) {
          showStatus(`Updated ${variable} ${column} to ${value}`, 'success');
        } else {
          showStatus('Update failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error updating value: ' + error.message, 'error');
      }
    }

    async function runQuery() {
      showLoading(true);
      const params = {
        spread: parseFloat(document.getElementById('spread').value) || DEFAULTS.spread,
        rateKA: parseFloat(document.getElementById('rateKA').value) || DEFAULTS.rateKA,
        ratePN: parseFloat(document.getElementById('ratePN').value) || DEFAULTS.ratePN,
        basedOnExecution: document.getElementById('basedOnExecution').checked ?? DEFAULTS.basedOnExecution
      };
      try {
        const response = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        const result = await response.json();
        if (result.success && result.data) {
          currentData = result.data.data;
          populateTable(result.data.data);
          showStatus(result.message || 'Calculations completed successfully', 'success');
        } else {
          showStatus('Query failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error running query: ' + error.message, 'error');
      }
      showLoading(false);
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
  </script>
</body>
</html>
