<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Web Application</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:1000px;margin:auto;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px}
    .header{text-align:center;margin-bottom:16px}
    .header h1{margin:0 0 6px 0;font-size:22px}
    .controls{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-end;margin-bottom:12px}
    .controls label{display:flex;flex-direction:column;font-weight:600;font-size:.92rem}
    .controls input{padding:8px 10px;border:1px solid #cbd5e1;border-radius:6px;font-size:.92rem}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{padding:8px 16px;border:none;border-radius:6px;background:#667eea;color:#fff;font-weight:600;cursor:pointer}
    button:hover{background:#5567c9}
    button.green{background:#059669}
    button.green:hover{background:#047857}
    button.red{background:#dc2626}
    button.red:hover{background:#b91c1c}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;border:1px solid #e5e7eb;text-align:left;font-size:.92rem}
    th{background:#667eea;color:#fff}
    tr:nth-child(even){background:#f9fafb}
    .status{margin-top:12px;padding:10px;border-radius:6px;display:none}
    .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .loading{display:none;text-align:center;margin:12px 0;color:#667eea;font-weight:600}

    /* Toggle switch */
    .toggle-container{display:flex;align-items:center;gap:8px;margin-left:4px}
    .toggle-switch{position:relative;display:inline-block;width:52px;height:28px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:#cbd5e1;transition:.3s;border-radius:28px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;background:#fff;transition:.3s;border-radius:50%}
    .toggle-switch input:checked + .slider{background:#667eea}
    .toggle-switch input:checked + .slider:before{transform:translateX(24px)}

    /* Formatting */
    td:first-child {
        text-transform: capitalize;
        letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <script>
    // Application configuration - starts with zeros, these are just for the "defaults" button
    const APP_DEFAULTS = {
        spread: 0.01,
        rateKA: 17.7055,
        ratePN: 1,
        basedOnMarketRate: false  // Changed from basedOnExecution to basedOnMarketRate, default false
    };

    const PROMPT_TO_RESET_TO_ZERO = true;
    const PROMPT_USER_ON_LOAD_EXAMPLES = true;

    // Example values for the "Revert to Defaults" button (testing/demo purposes)
    const EXAMPLE_VALUES = {
        'tradeprofit': { min: -88, max: -88 },
        'profitfactor': { min:-0.000497021, max: -0.000497021 },
        'tradeamount': { min: 10000.00, max: 10000.00 },
        'buyvariable': { min: 17.7055, max: 17.7055 },
        'sellvariable': { min: 17.6967, max: 17.6967 }
    };
  </script>

  <div class="container">
    <div class="header">
      <h1>Trade Web Application</h1>
      <p>Trading Calculations with Real-time Updates - Starts with Zero Values</p>
    </div>

    <!-- Top row: inputs -->
    <div class="controls">
      <label>
        Spread
        <input type="number" id="spread" step="0.01"/>
      </label>
      <label>
        Rate KA
        <input type="number" id="rateKA" step="0.01"/>
      </label>
      <label>
        Rate PN
        <input type="number" id="ratePN" step="0.01"/>
      </label>
    </div>

    <!-- Actions row: buttons + toggle -->
    <div class="actions">
      <button onclick="runQuery()">Run Calculations</button>
      <button onclick="loadExampleDefaults()" class="green">Load Example Values</button>
      <button onclick="resetToZero()" class="red">Reset to Zero</button>

      <div class="toggle-container" title="Toggle calculation mode">
        <span style="font-weight:600;color:#334155">Based on Market Rate</span>
        <label class="toggle-switch">
          <input type="checkbox" id="basedOnMarketRate"/>
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="loading" id="loading">Processing...</div>

    <table>
      <thead>
        <tr>
          <th>Variable</th>
          <th>Minimum</th>
          <th>Maximum</th>
          <th>Factor Min</th>
          <th>Factor Max</th>
          <th>Return Min</th>
          <th>Return Max</th>
        </tr>
      </thead>
      <tbody id="dataTable"></tbody>
    </table>

    <div id="status" class="status"></div>
  </div>

  <script>
    // Set application defaults for calculation parameters
    document.getElementById('spread').value = APP_DEFAULTS.spread;
    document.getElementById('rateKA').value = APP_DEFAULTS.rateKA;
    document.getElementById('ratePN').value = APP_DEFAULTS.ratePN;
    document.getElementById('basedOnMarketRate').checked = APP_DEFAULTS.basedOnMarketRate;

    let currentData = [];

    document.addEventListener('DOMContentLoaded', loadData);

    // Load example values for testing/demo (green button)
    async function loadExampleDefaults() {
      if (PROMPT_USER_ON_LOAD_EXAMPLES && !confirm('This will overwrite current values with examples. Continue?')) {
        return;
      }
      showLoading(true);
      try {
        let successCount = 0;
        
        // Update each variable with example values
        for (const [variable, values] of Object.entries(EXAMPLE_VALUES)) {
          // Update minimum
          await fetch('/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              variable: variable, 
              column: 'minimum', 
              value: values.min.toString() 
            })
          });
          
          // Update maximum
          await fetch('/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              variable: variable, 
              column: 'maximum', 
              value: values.max.toString() 
            })
          });
          
          successCount++;
        }
        
        // Reload the table to show new example values
        await loadData();
        showStatus(`Loaded example values for ${successCount} variables!`, 'success');
        
      } catch (error) {
        showStatus('Error loading example values: ' + error.message, 'error');
      }
      showLoading(false);
    }

    // Reset all values to zero (red button)
    async function resetToZero() {
        if (PROMPT_TO_RESET_TO_ZERO && !confirm('This will reset all values to zero. Continue?')) {
        return;
      }
      
      showLoading(true);
      try {
        const response = await fetch('/api/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resetType: 'zero' })
        });
        
        const result = await response.json();
        if (result.success) {
          await loadData(); // Reload table
          showStatus('All values reset to zero successfully!', 'success');
        } else {
          showStatus('Reset failed: ' + (result.error || 'Unknown error'), 'error');
        }
        
      } catch (error) {
        showStatus('Error resetting values: ' + error.message, 'error');
      }
      showLoading(false);
    }

    async function loadData() {
      showLoading(true);
      try {
        const response = await fetch('/api/data');
        const result = await response.json();
        if (result.data && result.data.length > 0) {
          currentData = result.data;
          populateTable(result.data);
          showStatus('Data loaded successfully', 'success');
        } else {
          showStatus('No data available - application starts with zero values', 'success');
          // Create empty table structure
          populateTable([]);
        }
      } catch (error) {
        showStatus('Error loading data: ' + error.message, 'error');
        populateTable([]); // Show empty table
      }
      showLoading(false);
    }

    function populateTable(data) {
      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        // Show empty message
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" style="text-align:center;color:#666;font-style:italic">Application starts with zero values - load examples or run calculations</td>';
        tbody.appendChild(row);
        return;
      }
      
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.variable}</td>
          <td><input type="number" step="0.000001" value="${item.minimum}"
              onchange="updateValue('${item.variable}', 'minimum', this.value)"></td>
          <td><input type="number" step="0.000001" value="${item.maximum}"
              onchange="updateValue('${item.variable}', 'maximum', this.value)"></td>
          <td>${parseFloat(item.factormin).toFixed(6)}</td>
          <td>${parseFloat(item.factormax).toFixed(6)}</td>
          <td>${parseFloat(item.returnmin).toFixed(6)}</td>
          <td>${parseFloat(item.returnmax).toFixed(6)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function updateValue(variable, column, value) {
      try {
        const response = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ variable, column, value })
        });
        const result = await response.json();
        if (result.success) {
          showStatus(`Updated ${variable} ${column} to ${value}`, 'success');
        } else {
          showStatus('Update failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error updating value: ' + error.message, 'error');
      }
    }

    async function runQuery() {
      showLoading(true);
      const params = {
        spread: parseFloat(document.getElementById('spread').value) || APP_DEFAULTS.spread,
        rateKA: parseFloat(document.getElementById('rateKA').value) || APP_DEFAULTS.rateKA,
        ratePN: parseFloat(document.getElementById('ratePN').value) || APP_DEFAULTS.ratePN,
        basedOnMarketRate: document.getElementById('basedOnMarketRate').checked ?? APP_DEFAULTS.basedOnMarketRate
      };
      
      console.log('Running calculations with parameters:', params);
      
      try {
        const response = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        const result = await response.json();
        if (result.success && result.data) {
          currentData = result.data.data;
          populateTable(result.data.data);
          showStatus(result.message || 'Calculations completed successfully', 'success');
        } else {
          showStatus('Query failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('Error running calculations: ' + error.message, 'error');
      }
      showLoading(false);
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
  </script>
</body>
</html>